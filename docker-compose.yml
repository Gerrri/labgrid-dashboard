# Labgrid Dashboard - Docker Compose Configuration
# Development environment with Labgrid Coordinator, Backend, and Frontend
#
# Profiles:
#   - default (no profile): Runs coordinator, backend, frontend
#   - staging: Adds 3 DUTs and exporters for realistic testing

version: "3.8"

services:
  # =============================================================================
  # Core Services (always running)
  # =============================================================================

  # Labgrid Coordinator - WAMP router for Labgrid communication
  coordinator:
    build:
      context: ./docker/coordinator
      dockerfile: Dockerfile
    container_name: labgrid-coordinator
    ports:
      - "20408:20408"
    networks:
      - labgrid-network
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', 20408)); s.close()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # FastAPI Backend - REST API and WebSocket server
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: labgrid-backend
    ports:
      - "8000:8000"
    environment:
      - COORDINATOR_URL=ws://coordinator:20408
      - COORDINATOR_REALM=realm1
      - COORDINATOR_TIMEOUT=30
      - PYTHONUNBUFFERED=1
    depends_on:
      coordinator:
        condition: service_healthy
    networks:
      - labgrid-network
    volumes:
      - ./backend:/app
    restart: unless-stopped

  # React Frontend - Development server with Vite
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: labgrid-frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000/api/ws
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend
    networks:
      - labgrid-network
    volumes:
      - ./frontend:/app
      - /app/node_modules
    restart: unless-stopped

  # =============================================================================
  # Staging Profile: DUT Containers (simulated devices)
  # =============================================================================

  # DUT 1 - Simulated device with serial-over-TCP
  dut-1:
    build:
      context: ./docker/dut
      dockerfile: Dockerfile
    container_name: labgrid-dut-1
    hostname: dut-1
    profiles: ["staging"]
    environment:
      - DUT_NAME=dut-1
    networks:
      - labgrid-network
    restart: unless-stopped

  # DUT 2 - Simulated device with serial-over-TCP
  dut-2:
    build:
      context: ./docker/dut
      dockerfile: Dockerfile
    container_name: labgrid-dut-2
    hostname: dut-2
    profiles: ["staging"]
    environment:
      - DUT_NAME=dut-2
    networks:
      - labgrid-network
    restart: unless-stopped

  # DUT 3 - Simulated device with serial-over-TCP
  dut-3:
    build:
      context: ./docker/dut
      dockerfile: Dockerfile
    container_name: labgrid-dut-3
    hostname: dut-3
    profiles: ["staging"]
    environment:
      - DUT_NAME=dut-3
    networks:
      - labgrid-network
    restart: unless-stopped

  # =============================================================================
  # Staging Profile: Labgrid Exporters
  # =============================================================================

  # Exporter 1 - Exports DUT-1 to Labgrid Coordinator
  exporter-1:
    build:
      context: ./docker/exporter
      dockerfile: Dockerfile
    container_name: labgrid-exporter-1
    hostname: exporter-1
    profiles: ["staging"]
    environment:
      - DUT_HOST=dut-1
      - DUT_PORT=5000
      - EXPORTER_NAME=exporter-1
      - COORDINATOR_URL=ws://coordinator:20408/ws
    depends_on:
      - dut-1
      - coordinator
    networks:
      - labgrid-network
    restart: unless-stopped

  # Exporter 2 - Exports DUT-2 to Labgrid Coordinator
  exporter-2:
    build:
      context: ./docker/exporter
      dockerfile: Dockerfile
    container_name: labgrid-exporter-2
    hostname: exporter-2
    profiles: ["staging"]
    environment:
      - DUT_HOST=dut-2
      - DUT_PORT=5000
      - EXPORTER_NAME=exporter-2
      - COORDINATOR_URL=ws://coordinator:20408/ws
    depends_on:
      - dut-2
      - coordinator
    networks:
      - labgrid-network
    restart: unless-stopped

  # Exporter 3 - Exports DUT-3 to Labgrid Coordinator
  exporter-3:
    build:
      context: ./docker/exporter
      dockerfile: Dockerfile
    container_name: labgrid-exporter-3
    hostname: exporter-3
    profiles: ["staging"]
    environment:
      - DUT_HOST=dut-3
      - DUT_PORT=5000
      - EXPORTER_NAME=exporter-3
      - COORDINATOR_URL=ws://coordinator:20408/ws
    depends_on:
      - dut-3
      - coordinator
    networks:
      - labgrid-network
    restart: unless-stopped

  # =============================================================================
  # Staging Profile: Init Container for Auto-Acquire
  # =============================================================================

  # Init-Acquire - Automatically acquires exporter-1 for demonstration
  # This runs once at startup to show "acquired" status in the dashboard
  init-acquire:
    build:
      context: ./docker/init-acquire
      dockerfile: Dockerfile
    container_name: labgrid-init-acquire
    profiles: ["staging"]
    environment:
      # Coordinator connection (host:port format for labgrid-client)
      - COORDINATOR_HOST=coordinator:20408
      # Place name to create and acquire
      - PLACE_NAME=exporter-1
      # Exporter to match resources from
      - EXPORTER_NAME=exporter-1
      # Username shown in dashboard as "acquired_by"
      - USER_NAME=staging-user
      # Wait time for services to initialize
      - WAIT_TIME=15
    depends_on:
      coordinator:
        condition: service_healthy
      exporter-1:
        condition: service_started
      exporter-2:
        condition: service_started
      exporter-3:
        condition: service_started
    networks:
      - labgrid-network
    # Restart policy: no (runs once then exits)
    restart: "no"

networks:
  labgrid-network:
    driver: bridge
    name: labgrid-network
